<!DOCTYPE html>
<html lang=zh-CN>
  <head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="mall整合Elasticsearch实现商品搜索项目使用框架介绍Elasticsearch Elasticsearch是一个分布式、可扩展、实时的搜索与数据分析引擎。它能从项目一开始就赋予你的数据以搜索、分析和探索的能力，可用于实现全文 搜索和实时数据统计   版本7.17.3  Spring Data Elasticsearch Spring Data Elasticsearch是Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="mall整合Elasticsearch实现商品搜索">
<meta property="og:url" content="https://www.t1kcode.top/posts/20230323121710-57e98fa8.html">
<meta property="og:site_name" content="t1kcode">
<meta property="og:description" content="mall整合Elasticsearch实现商品搜索项目使用框架介绍Elasticsearch Elasticsearch是一个分布式、可扩展、实时的搜索与数据分析引擎。它能从项目一开始就赋予你的数据以搜索、分析和探索的能力，可用于实现全文 搜索和实时数据统计   版本7.17.3  Spring Data Elasticsearch Spring Data Elasticsearch是Spring">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.t1kcode.top/image/elasticsearch/SimpleElasticsearchRepository.jpg">
<meta property="og:image" content="https://www.t1kcode.top/image/elasticsearch/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E7%A4%BA%E4%BE%8B%E5%9B%BE.png">
<meta property="article:published_time" content="2023-03-23T04:17:10.000Z">
<meta property="article:modified_time" content="2023-03-25T16:06:30.617Z">
<meta property="article:author" content="t1k">
<meta property="article:tag" content="ES">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.t1kcode.top/image/elasticsearch/SimpleElasticsearchRepository.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/Rolan.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    
      <title>t1kcode·mall整合Elasticsearch实现商品搜索</title>
    
    
    <!-- styles -->

    <!-- 默认CSS引入方法 -->
    
<link rel="stylesheet" href="/css/layout.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	


  
  <!-- L2Dwidget -->
  
<script src="/lib/live2d/L2Dwidget.min.js"></script>


  <script>
  // 猫
  L2Dwidget.init({
    model: {
      jsonPath: "/lib/live2d/tororo/assets/tororo.model.json",
    },
    display: {
      superSample: 2,
      width: 60,
      height: 80,
      position: 'right',
      hOffset: 0,
      vOffset: 20,
    },
    mobile: {
      show: true,
      scale: 1,
      motion: true,
    },
    react: {
      opacityDefault: 1,
      opacityOnHover: 1,
    }
  })
  //百度搜索爬虫



var _hmt = _hmt || [];
(function () {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7e9a19e5e700f1a2607b47c7bd6b35e8";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();

  </script>
  <meta name="baidu-site-verification" content="code-dIan6MAmy5" />
  

  <!-- styles -->


 
  <link
    rel="preload"
    href="/lib/font-awesome/css/all.min.css"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript
    ><link
      rel="stylesheet"
      href="/lib/font-awesome/css/all.min.css"
  /></noscript>



<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="max-width mx-auto">
     <div class="home">
        <!-- //actions_desktop 右上角导航栏 -->
      <aside id="#aside" class="hubzy_left">
        
          <div class="hubzy_logo">
	<a href="/">
		
		  
					<div id="logo" style="background-image: url(/images/logo.jpg);"></div>
					
					  
	  </a>
	  <div id="title">
		<a href="/">
		  <h1>
			t1k
		  </h1>
		</a>
		
			<!-- icon列表 -->
			  <p class="iconlist">
				<!-- # > index.find_me_on -->
				
				
				
				
				  
					<a class="icon" target="_blank" rel="noopener" href="https://github.com/t1kcode" aria-label="github">
					  <i class="fab fa-github"></i></a>
					  
			     
				  
				
				  
					<a class="icon" target="_blank" rel="noopener" href="https://gitee.com/t1kcode">
					  <i><svg class='diyIcon'  viewBox="0 0 1024 1024" ><path d="M512 1024C229.248 1024 0 794.752 0 512S229.248 0 512 0s512 229.248 512 512-229.248 512-512 512z m259.168-568.896h-290.752a25.28 25.28 0 0 0-25.28 25.28l-0.032 63.232c0 13.952 11.296 25.28 25.28 25.28h177.024a25.28 25.28 0 0 1 25.28 25.28v12.64a75.84 75.84 0 0 1-75.84 75.84h-240.224a25.28 25.28 0 0 1-25.28-25.28v-240.192a75.84 75.84 0 0 1 75.84-75.84h353.92a25.28 25.28 0 0 0 25.28-25.28l0.064-63.2a25.312 25.312 0 0 0-25.28-25.312H417.184a189.632 189.632 0 0 0-189.632 189.6v353.952c0 13.952 11.328 25.28 25.28 25.28h372.928a170.656 170.656 0 0 0 170.656-170.656v-145.376a25.28 25.28 0 0 0-25.28-25.28z"></path></svg></i>
					</a>
				  
			  
				  
				
			  </p>
			
	  </div>
</div>
<!-- 搜索栏 -->
<div id="search">
	<input class="search-input" type="text" placeholder="search">
	<span id="search-icon" class="fa fa-bars" title="展开目录"></span>
</div>

<!-- 侧边目录栏 -->
<div id="tree">
	

	
					<ul>
						<li class="file">
							<a href="/posts/20191207173653-34322.html">
								<i class="fa fa-file"></i>
								2019-12-07-个人博客搭建流程及一些问题
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210308180810-45748.html">
								<i class="fa fa-file"></i>
								2021-03-12-单链表
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210305160710-52078.html">
								<i class="fa fa-file"></i>
								2021-03-13-顺序表
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210314161900-40356.html">
								<i class="fa fa-file"></i>
								2021-03-14-C++那些事
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210323180810-48829.html">
								<i class="fa fa-file"></i>
								2021-03-23-循环链表
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210328161810-12508.html">
								<i class="fa fa-file"></i>
								2021-03-28-双向循环链表
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210401203910-37273.html">
								<i class="fa fa-file"></i>
								2021-04-01-栈
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210410143910-48527.html">
								<i class="fa fa-file"></i>
								2021-04-010-基数排序
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210402190010-36496.html">
								<i class="fa fa-file"></i>
								2021-04-02-栈的应用
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210403143910-26671.html">
								<i class="fa fa-file"></i>
								2021-04-03-队列
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210501195710-23384.html">
								<i class="fa fa-file"></i>
								2021-05-01-树
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20210422183910-27506.html">
								<i class="fa fa-file"></i>
								2021-4-22-查找
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20221001175710-33701.html">
								<i class="fa fa-file"></i>
								2022-10-01-JAVA基础
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20221203185710-45889.html">
								<i class="fa fa-file"></i>
								2022-12-03-电脑商城项目
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230216100710-1bff3c65.html">
								<i class="fa fa-file"></i>
								2023-2-16-MyBatis
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230218080710-bed8b4fb.html">
								<i class="fa fa-file"></i>
								2023-2-18-MyBatis Generator
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230227202410-ed4aca2b.html">
								<i class="fa fa-file"></i>
								2023-2-27-SpringSecurityJWT
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230311163310-3b72b36d.html">
								<i class="fa fa-file"></i>
								2023-3-11-Mall整合SpringTask
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230311153410-8ead567e.html">
								<i class="fa fa-file"></i>
								2023-3-11-MongoDB
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230314103110-e0a3f475.html">
								<i class="fa fa-file"></i>
								2023-3-14-RabbitMQ_JAVA
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230315220410-e0a3f475.html">
								<i class="fa fa-file"></i>
								2023-3-15-Mall整合RabbitMQ
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230317105310-7d1f0793.html">
								<i class="fa fa-file"></i>
								2023-3-17-SpringBoot中使用AOP记录接口访问日志
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230302211010-feec57d.html">
								<i class="fa fa-file"></i>
								2023-3-2-Spring Data Redis
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230320134010-cc2903eb.html">
								<i class="fa fa-file"></i>
								2023-3-20-Mall商城
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file active">
							<a href="/posts/20230323121710-57e98fa8.html">
								<i class="fa fa-file"></i>
								2023-3-23-Mall整合Elasticsearch
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230302105710-8aebab8e.html">
								<i class="fa fa-file"></i>
								2023-3-3-Mall-SpringSecurity-JWT
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230303201610-6b63fba0.html">
								<i class="fa fa-file"></i>
								2023-3-3-Swagger-UI
							</a>
						</li>
					</ul>
	
					<ul>
						<li class="file">
							<a href="/posts/20230305194310-d48132d3.html">
								<i class="fa fa-file"></i>
								2023-3-5-ElasticSearch
							</a>
						</li>
					</ul>
	
</div>

        
      </aside>
      <div id="header-post" class="hubzy_right">
        
          
  <!-- <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a> -->
  <!-- <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a> -->
  <!-- <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"
    style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a> -->
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/blog/">
              首页
            </a></li>
          
          <li><a href="/categories/">
              分类
            </a></li>
          
          <li><a href="/archives/">
              归档
            </a></li>
          
          <li><a href="/">
              关于
            </a></li>
          
      </ul>
    </span>
    <br />
    <div id="toc">
      
    </div>
    <br />
    <span id="actions">
      <ul>
        <!--// 
            
              <li><a class="icon" aria-label="下一篇 " href="/posts/20230320134010-cc2903eb.html"><i
                    class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();"
                    onmouseout="$('#i-next').toggle();"></i></a></li>
              // -->
                <li><a class="icon" aria-label="返回顶部 " href="#"
                    onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up"
                      aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a>
                </li>
                <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt"
                      aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();"
                      onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">
        上一篇
      </span>
      <span id="i-next" class="info" style="display:none;">
        下一篇
      </span>
      <span id="i-top" class="info" style="display:none;">
        返回顶部
      </span>
      <span id="i-share" class="info" style="display:none;">
        分享文章
      </span>
    </span>
    <br />
    <div id="share" style="display: none">
      <ul>
  <li> 开发中. </li>
  <!-- <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&text=mall整合Elasticsearch实现商品搜索"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&is_video=false&description=mall整合Elasticsearch实现商品搜索"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mall整合Elasticsearch实现商品搜索&body=Check out this article: https://www.t1kcode.top/posts/20230323121710-57e98fa8.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&name=mall整合Elasticsearch实现商品搜索&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&t=mall整合Elasticsearch实现商品搜索"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li> -->

</ul>

    </div>

  </span>

        
      </div>
       
      <div class="content  hubzy_center">
        
          <!-- //body 引入首页和md编译后的页面 -->
          <!-- md 编译成 html 后的文件模板 -->

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="hubzy_center_title">
    
    <h1 class="posttitle" itemprop="name headline">
        mall整合Elasticsearch实现商品搜索
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">t1k</span>
      </span>
      <!-- 文章时间和首页时间 -->

    <div class="postdate">
      
        <time datetime="2023-03-23T04:17:10.000Z" itemprop="datePublished">2023-03-23</time>
        
        <!-- (Updated: <time datetime="2023-03-25T16:06:30.617Z" itemprop="dateModified">2023-03-26</time>) -->
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/ES/">ES</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ES/" rel="tag">ES</a>
    </div>


    </div>
  </header>
  

  <div class="content conterDiy"  id="article" itemprop="articleBody">
    <em class="nubScript">
        ·本篇:6k字 大约需要: 30分钟
    </em>
    <h1 id="mall整合Elasticsearch实现商品搜索"><a href="#mall整合Elasticsearch实现商品搜索" class="headerlink" title="mall整合Elasticsearch实现商品搜索"></a>mall整合Elasticsearch实现商品搜索</h1><h2 id="项目使用框架介绍"><a href="#项目使用框架介绍" class="headerlink" title="项目使用框架介绍"></a>项目使用框架介绍</h2><h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><blockquote>
<p><strong>Elasticsearch是一个分布式、可扩展、实时的搜索与数据分析引擎。它能从项目一开始就赋予你的数据以搜索、分析和探索的能力，可用于实现全文 搜索和实时数据统计</strong></p>
</blockquote>
<blockquote>
<p><strong>版本7.17.3</strong></p>
</blockquote>
<h3 id="Spring-Data-Elasticsearch"><a href="#Spring-Data-Elasticsearch" class="headerlink" title="Spring Data Elasticsearch"></a>Spring Data Elasticsearch</h3><blockquote>
<p><strong>Spring Data Elasticsearch是Spring提供的一种以Spring Data风格来操作数据存储的方式，它可以避免编写大量的样板代码</strong></p>
</blockquote>
<h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><h5 id="Document"><a href="#Document" class="headerlink" title="@Document"></a>@Document</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标示映射到Elasticsearch文档上的领域对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Document &#123;</span><br><span class="line">  <span class="comment">// 索引库名次，mysql中数据库的概念</span></span><br><span class="line">	String <span class="title function_">indexName</span><span class="params">()</span>;</span><br><span class="line">  <span class="comment">// 文档类型，mysql中表的概念</span></span><br><span class="line">	String <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="comment">// 默认分片数</span></span><br><span class="line">	<span class="type">short</span> <span class="title function_">shards</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">5</span>;</span><br><span class="line">  <span class="comment">// 默认副本数量</span></span><br><span class="line">	<span class="type">short</span> <span class="title function_">replicas</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Id"><a href="#Id" class="headerlink" title="@Id"></a>@Id</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="comment">// 表示文档的id</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Id &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Field"><a href="#Field" class="headerlink" title="@Field"></a>@Field</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Field &#123;</span><br><span class="line">  <span class="comment">// 文档中字段的类型</span></span><br><span class="line">	FieldType <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> FieldType.Auto;</span><br><span class="line">  <span class="comment">// 是否建立倒排索引</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">index</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 是否进行存储</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">store</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 分词器名次</span></span><br><span class="line">	String <span class="title function_">analyzer</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为文档自动指定元数据类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">FieldType</span> &#123;</span><br><span class="line">	Text, <span class="comment">// 会进行分词并建了索引的字符类型</span></span><br><span class="line">	Integer,</span><br><span class="line">	Long,</span><br><span class="line">	Date,</span><br><span class="line">	Float,</span><br><span class="line">	Double,</span><br><span class="line">	Boolean,</span><br><span class="line">	Object,</span><br><span class="line">	Auto,<span class="comment">// 自动判断字段类型</span></span><br><span class="line">	Nested,<span class="comment">// 嵌套对象类型</span></span><br><span class="line">	Ip,</span><br><span class="line">	Attachment,</span><br><span class="line">	Keyword <span class="comment">// 不会进行分词建立索引的类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring-Data方式的数据操作"><a href="#Spring-Data方式的数据操作" class="headerlink" title="Spring Data方式的数据操作"></a>Spring Data方式的数据操作</h4><p><strong>继承ElasticsearchRepository&lt;T, ID&gt;接口可以获得常用的数据操作方法，T类型为映射的类对象类型，ID为设置的文档id的类型</strong></p>
<p>**因为ElasticsearchRepository&lt;T, ID&gt;在源码中有一个SimpleElasticsearchRepository&lt;T, ID&gt;的实现类，该类已经实现了一些基础操作 **</p>
<p><img src="/image/elasticsearch/SimpleElasticsearchRepository.jpg" alt="SimpleElasticsearchRepository"></p>
<h5 id="衍生查询"><a href="#衍生查询" class="headerlink" title="衍生查询"></a>衍生查询</h5><blockquote>
<p><strong>在继承接口的实现类中指定查询方法名称即可查询，无需进行实现，如商品表中有商品名称、标题和关键字，直接定义如下查询，就可以对这三个字段进行全文搜索findAllByName</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品ES操作类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EsProductRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;EsProduct, Long&gt; </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name              商品名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subTitle          商品标题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyword          商品关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page              分页信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;EsProduct&gt; <span class="title function_">findByNameOrSubTitleOrKeywords</span><span class="params">(String name, String subTitle, String keyword, Pageable page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">关键字</th>
<th align="center">使用示例</th>
<th align="center">等同于的ES查询</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>And</strong></td>
<td align="center"><strong>findByNameAndPrice</strong></td>
<td align="center"><strong>{“bool”: {“must”: [{“field”: {“name”: “?”}}, {“field”: {“price”: “?”}}]}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Or</strong></td>
<td align="center"><strong>findByNameOrPrice</strong></td>
<td align="center"><strong>{“bool”: {“should”: [{“field”: {“name”: “?”}}, {“field”: {“price”: “?”}}]}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Is</strong></td>
<td align="center"><strong>findByName</strong></td>
<td align="center"><strong>{“bool”: {“must”: [{“field”: {“name”: “?”}}]}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Not</strong></td>
<td align="center"><strong>findByNameNot</strong></td>
<td align="center"><strong>{“bool”: {“must_not”: [{“field”: {“name”: “?”}}]}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Between</strong></td>
<td align="center"><strong>findByPriceBetween</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“range”: {“price”: {“from”: ?, “to”: ?, “include_lower”: true, “include_upper”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>LessThanEqual</strong></td>
<td align="center"><strong>findByPriceLessThan</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“range”: {“price”: {“from”: null, “to”: ?, “include_lower”: true, “include_upper”: true}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>GreaterThanEqual</strong></td>
<td align="center"><strong>findByPriceGreaterThan</strong></td>
<td align="center"><strong>{“from”: ?, “to”: null, “include_lower”: true, “include_upper”: true}</strong></td>
</tr>
<tr>
<td align="center"><strong>Before</strong></td>
<td align="center"><strong>findByPriceBefore</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“range”: {“price”: {“from”: null, “to”: ?, “include_lower”: true, “include_upper”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>After</strong></td>
<td align="center"><strong>findByPriceAfter</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“range”: {“price”: {“from”: ?, “to”: null, “include_lower”: true, “include_upper”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Like</strong></td>
<td align="center"><strong>findByNameLike</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“name”: {“query”: ?, “analyze_wildcard”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>StartingWith</strong></td>
<td align="center"><strong>findByNameStartingWith</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“name”: {“query”: “?*”, “analyze_wildcard”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>EndingWith</strong></td>
<td align="center"><strong>findByNameEndingWith</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“name”: {“query”: “*?”, “analyze_wildcard”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>Contains&#x2F;Conta</strong></td>
<td align="center"><strong>findByNameContaining</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“name”: {“query”: “?”, “analyze_wildcard”: true}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>In</strong></td>
<td align="center"><strong>findByNameIn(Collectionnames)</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“bool”: {“should”: [{“field”: {“name”: “?”}}, {“field”: {“name”: “?”}}]}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>NotIn</strong></td>
<td align="center"><strong>findByNameNotIn(Collectionnames)</strong></td>
<td align="center"><strong>{“bool”: {“must_not”: {“bool”: {“should”: {“field”: {“name”: “?”}}}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>True</strong></td>
<td align="center"><strong>findByAvailableTrue</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“available”: true}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>False</strong></td>
<td align="center"><strong>findByAvailableFalse</strong></td>
<td align="center"><strong>{“bool”: {“must”: {“field”: {“available”: false}}}}</strong></td>
</tr>
<tr>
<td align="center"><strong>OrderBy</strong></td>
<td align="center"><strong>findByAvailableTrueOrderByNameDesc</strong></td>
<td align="center"><strong>{“sort”: [{“name”: {“order”: “desc”}}], “bool”: {“must”: {“field”: {“available”: true}}}}</strong></td>
</tr>
</tbody></table>
<h5 id="使用-Query注解可以用Elasticsearch的DSL语句进行查询"><a href="#使用-Query注解可以用Elasticsearch的DSL语句进行查询" class="headerlink" title="使用@Query注解可以用Elasticsearch的DSL语句进行查询"></a>使用@Query注解可以用Elasticsearch的DSL语句进行查询</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(&quot;&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?0&quot;&#125;&#125;&#125;&#125;&quot;)</span></span><br><span class="line">Page&lt;EsProduct&gt; <span class="title function_">findByName</span><span class="params">(String name,Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="项目使用表说明"><a href="#项目使用表说明" class="headerlink" title="项目使用表说明"></a>项目使用表说明</h2><ul>
<li><p><strong><code>pms_product</code>：商品信息表</strong></p>
</li>
<li><p><strong><code>pms_product_attribute</code>：商品属性参数表</strong></p>
</li>
<li><p><strong><code>pms_product_attribute_value</code>：存储产品参数值表</strong></p>
</li>
</ul>
<h2 id="整合Elasticsearch实现商品搜索"><a href="#整合Elasticsearch实现商品搜索" class="headerlink" title="整合Elasticsearch实现商品搜索"></a>整合Elasticsearch实现商品搜索</h2><h3 id="在pom-xml中添加相关依赖"><a href="#在pom-xml中添加相关依赖" class="headerlink" title="在pom.xml中添加相关依赖"></a>在pom.xml中添加相关依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Elasticsearch相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="修改SpringBoot配置文件"><a href="#修改SpringBoot配置文件" class="headerlink" title="修改SpringBoot配置文件"></a>修改SpringBoot配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">elasticsearch:</span></span><br><span class="line">      <span class="attr">repositories:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">uris:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9200</span></span><br></pre></td></tr></table></figure>

<h3 id="添加商品文档对象EsProduct"><a href="#添加商品文档对象EsProduct" class="headerlink" title="添加商品文档对象EsProduct"></a>添加商品文档对象EsProduct</h3><blockquote>
<p><strong>不需要中文分词的字段设置成@Field(type &#x3D; FieldType.Keyword)类型，需要中文分词的设置成@Field(analyzer &#x3D; “ik_max_word”, type &#x3D; FieldType.Text)类型</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品的信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="comment">// 索引名称</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;pms&quot;)</span></span><br><span class="line"><span class="comment">// shards 分片 replicas 副本</span></span><br><span class="line"><span class="meta">@Setting(shards = 1, replicas = 0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsProduct</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String productSn; <span class="comment">// 货号</span></span><br><span class="line">    <span class="keyword">private</span> Long brandId; <span class="comment">// 品牌id</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String brandName; <span class="comment">// 品牌名</span></span><br><span class="line">    <span class="keyword">private</span> Long productCategoryId; <span class="comment">// 商品属性类别id</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String productCategoryName; <span class="comment">// 商品属性名称</span></span><br><span class="line">    <span class="keyword">private</span> String pic; <span class="comment">// 商品图片链接</span></span><br><span class="line">    <span class="meta">@Field(analyzer = &quot;ik_max_word&quot;,type = FieldType.Text)</span></span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// 商品标题</span></span><br><span class="line">    <span class="meta">@Field(analyzer = &quot;ik_max_word&quot;,type = FieldType.Text)</span></span><br><span class="line">    <span class="keyword">private</span> String subTitle; <span class="comment">// 商品副标题</span></span><br><span class="line">    <span class="meta">@Field(analyzer = &quot;ik_max_word&quot;,type = FieldType.Text)</span></span><br><span class="line">    <span class="keyword">private</span> String keywords; <span class="comment">// 商品关键字</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price; <span class="comment">// 商品价格</span></span><br><span class="line">    <span class="keyword">private</span> Integer sale; <span class="comment">// 商品销量</span></span><br><span class="line">    <span class="keyword">private</span> Integer newStatus; <span class="comment">// 新品状态</span></span><br><span class="line">    <span class="keyword">private</span> Integer recommandStatus; <span class="comment">// 推荐状态</span></span><br><span class="line">    <span class="keyword">private</span> Integer stock; <span class="comment">// 库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer promotionType; <span class="comment">// 促销类型</span></span><br><span class="line">    <span class="keyword">private</span> Integer sort; <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">// nested 允许对象数组以一种可以相互独立查询的方式进行索引，</span></span><br><span class="line">    <span class="comment">// 在nested内部，每个对象索引其实是一个单独的隐藏文档，</span></span><br><span class="line">    <span class="comment">// 意味着每个嵌套对象都可以独立于其它对象进行查询</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Nested)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;EsProductAttributeValue&gt; attrValueList; <span class="comment">// 商品属性信息列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加EsProductRepository接口用于操作Elasticsearch"><a href="#添加EsProductRepository接口用于操作Elasticsearch" class="headerlink" title="添加EsProductRepository接口用于操作Elasticsearch"></a>添加EsProductRepository接口用于操作Elasticsearch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品ES操作类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EsProductRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;EsProduct, Long&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜索查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name              商品名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subTitle          商品标题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyword          商品关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page              分页信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;EsProduct&gt; <span class="title function_">findByNameOrSubTitleOrKeywords</span><span class="params">(String name, String subTitle, String keyword, Pageable page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加EsProductService接口"><a href="#添加EsProductService接口" class="headerlink" title="添加EsProductService接口"></a>添加EsProductService接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品管理Service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EsProductService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从数据库中导入所有商品到ES</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">importAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id创建商品文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EsProduct <span class="title function_">create</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除商品文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除商品文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(List&lt;Long&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据关键字搜索商品名称或者副标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;EsProduct&gt; <span class="title function_">search</span><span class="params">(String keyword, Integer pageNum, Integer pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据关键字搜索名称或者副标题复合查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;EsProduct&gt; <span class="title function_">search</span><span class="params">(String keyword, Long brandId, Long productCategoryId, Integer pageNum, Integer pageSize,Integer sort)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据商品id推荐相关商品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;EsProduct&gt; <span class="title function_">recommend</span><span class="params">(Long id, Integer pageNum, Integer pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取搜索词相关品牌、分类、属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EsProductRelatedInfo <span class="title function_">searchRelatedInfo</span><span class="params">(String keyword)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加EsProductService接口的实现类EsProductServiceImpl"><a href="#添加EsProductService接口的实现类EsProductServiceImpl" class="headerlink" title="添加EsProductService接口的实现类EsProductServiceImpl"></a>添加EsProductService接口的实现类EsProductServiceImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品管理Service实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsProductServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EsProductService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(EsProductServiceImpl.class);</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EsProductDao productDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EsProductRepository productRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">importAll</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从数据库中获取所有商品信息</span></span><br><span class="line">        List&lt;EsProduct&gt; esProductList = productDao.getAllEsProductList(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 将数据库中的数据存入ES中</span></span><br><span class="line">        Iterable&lt;EsProduct&gt; esProductIterable = productRepository.saveAll(esProductList);</span><br><span class="line">        <span class="comment">// 获取响应对象的迭代器</span></span><br><span class="line">        Iterator&lt;EsProduct&gt; iterator = esProductIterable.iterator();</span><br><span class="line">        <span class="comment">// 统计导入的数据条数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">            result++;</span><br><span class="line">            iterator.next();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        productRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EsProduct <span class="title function_">create</span><span class="params">(Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">EsProduct</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 从数据库中根据id获取商品数据</span></span><br><span class="line">        List&lt;EsProduct&gt; esProductList = productDao.getAllEsProductList(id);</span><br><span class="line">        <span class="comment">// 判断数据库中是否有该id商品数据</span></span><br><span class="line">        <span class="keyword">if</span>(esProductList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 获取商品数据</span></span><br><span class="line">            <span class="type">EsProduct</span> <span class="variable">esProduct</span> <span class="operator">=</span> esProductList.get(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 存入ES</span></span><br><span class="line">            result = productRepository.save(esProduct);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(List&lt;Long&gt; ids)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 判断参数是否为空，没有判断id是否合法</span></span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(ids))&#123;</span><br><span class="line">            <span class="comment">// 传入ES的参数要为对象</span></span><br><span class="line">            List&lt;EsProduct&gt; esProductList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ids.forEach(id -&gt; &#123;</span><br><span class="line">                <span class="type">EsProduct</span> <span class="variable">esProduct</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsProduct</span>();</span><br><span class="line">                esProduct.setId(id);</span><br><span class="line">                esProductList.add(esProduct);</span><br><span class="line">            &#125;);</span><br><span class="line">            productRepository.deleteAll(esProductList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;EsProduct&gt; <span class="title function_">search</span><span class="params">(String keyword, Integer pageNum, Integer pageSize)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取分页信息包装类</span></span><br><span class="line">        <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(pageNum, pageSize);</span><br><span class="line">        <span class="keyword">return</span> productRepository.findByNameOrSubTitleOrKeywords(keyword, keyword, keyword, pageable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;EsProduct&gt; <span class="title function_">search</span><span class="params">(String keyword, Long brandId, Long productCategoryId, Integer pageNum,</span></span><br><span class="line"><span class="params">                                  Integer pageSize, Integer sort)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取分页信息包装类</span></span><br><span class="line">        <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// NativeSearchQuery查询对象构造器</span></span><br><span class="line">        <span class="type">NativeSearchQueryBuilder</span> <span class="variable">nativeSearchQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        nativeSearchQueryBuilder.withPageable(pageable);</span><br><span class="line">        <span class="comment">//过滤</span></span><br><span class="line">        <span class="keyword">if</span>(!Objects.isNull(brandId) || !Objects.isNull(productCategoryId))&#123;</span><br><span class="line">            <span class="comment">// 获取bool查询对象构造器</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">            <span class="keyword">if</span>(!Objects.isNull(brandId))&#123;</span><br><span class="line">                <span class="comment">// terms查询，基于关键字查询</span></span><br><span class="line">                boolQueryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;brandId&quot;</span>, brandId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!Objects.isNull(productCategoryId))&#123;</span><br><span class="line">                boolQueryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;productCategoryId&quot;</span>, productCategoryId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 加入过滤条件</span></span><br><span class="line">            nativeSearchQueryBuilder.withFilter(boolQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//搜索</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">            <span class="comment">// 如果关键词为空，则查询所有文档</span></span><br><span class="line">            nativeSearchQueryBuilder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            List&lt;FunctionScoreQueryBuilder.FilterFunctionBuilder&gt; filterFunctionBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 过滤函数构造器</span></span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">10</span>))); <span class="comment">// 设置多字段查询权重</span></span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;subTitle&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">5</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;keywords&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)));</span><br><span class="line">            FunctionScoreQueryBuilder.FilterFunctionBuilder[] builders = <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[filterFunctionBuilders.size()];</span><br><span class="line">            filterFunctionBuilders.toArray(builders); <span class="comment">// 转换为数组形式</span></span><br><span class="line">            <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQueryBuilder</span> <span class="operator">=</span> QueryBuilders.functionScoreQuery(builders)</span><br><span class="line">                                                                               .scoreMode(FunctionScoreQuery.ScoreMode.SUM) <span class="comment">// 对结果分数求和</span></span><br><span class="line">                                                                               .setMinScore(<span class="number">2</span>);</span><br><span class="line">            nativeSearchQueryBuilder.withQuery(functionScoreQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        <span class="keyword">if</span>(sort == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//按新品从新到旧</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;id&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">//按销量从高到低</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;sale&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">//按价格从低到高</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.ASC));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="comment">//按价格从高到低</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//按相关度</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.scoreSort().order(SortOrder.DESC));</span><br><span class="line">        &#125;</span><br><span class="line">        nativeSearchQueryBuilder.withSorts(SortBuilders.scoreSort().order(SortOrder.DESC));</span><br><span class="line">        <span class="comment">// NativeSearchQuery 查询对象</span></span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> nativeSearchQueryBuilder.build();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;DSL:&#123;&#125;&quot;</span>, searchQuery.getQuery().toString());</span><br><span class="line">        <span class="comment">// 查询结果Hit数组</span></span><br><span class="line">        SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">        <span class="comment">// 查询到的总条数</span></span><br><span class="line">        <span class="keyword">if</span>(searchHits.getTotalHits() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 没有查询到，返回空</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty(), pageable, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取查询到的对象</span></span><br><span class="line">        List&lt;EsProduct&gt; searchProductList = searchHits.stream()</span><br><span class="line">                                                      .map(SearchHit::getContent)</span><br><span class="line">                                                      .collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 封装为分页对象返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(searchProductList, pageable, searchHits.getTotalHits());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Page&lt;EsProduct&gt; <span class="title function_">searchSub</span><span class="params">(String keyword, Long brandId, Long productCategoryId, Integer pageNum,</span></span><br><span class="line"><span class="params">                                  Integer pageSize, Integer sort)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取分页信息包装类</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// NativeSearchQuery查询对象构造器</span></span><br><span class="line">        <span class="type">NativeSearchQueryBuilder</span> <span class="variable">nativeSearchQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        nativeSearchQueryBuilder.withPageable(pageRequest);</span><br><span class="line">        <span class="comment">//过滤，如果brandId或者productCategoryId不为空才构造过滤条件</span></span><br><span class="line">        <span class="keyword">if</span>(!Objects.isNull(brandId) || !Objects.isNull(productCategoryId))&#123;</span><br><span class="line">            <span class="comment">// 获取bool查询对象构造器</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>();</span><br><span class="line">            <span class="keyword">if</span>(!Objects.isNull(brandId))&#123;</span><br><span class="line">                <span class="comment">// terms查询，基于关键字查询</span></span><br><span class="line">                boolQueryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;brandId&quot;</span>, brandId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!Objects.isNull(productCategoryId))&#123;</span><br><span class="line">                boolQueryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;productCategoryId&quot;</span>, productCategoryId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 向构造器中加入过滤条件</span></span><br><span class="line">            nativeSearchQueryBuilder.withFilter(boolQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造搜索条件</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">            <span class="comment">// 如果关键词为空，则查询所有文档</span></span><br><span class="line">            nativeSearchQueryBuilder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 构造filterFunctionBuilderList</span></span><br><span class="line">            List&lt;FunctionScoreQueryBuilder.FilterFunctionBuilder&gt; filterFunctionBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 构造查询条件，并设置多字段查询权重</span></span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, keyword),</span><br><span class="line">                                       ScoreFunctionBuilders.weightFactorFunction(<span class="number">10</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;subTitle&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">5</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;keywords&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)));</span><br><span class="line">            <span class="comment">// 加入查询条件</span></span><br><span class="line">            FunctionScoreQueryBuilder.FilterFunctionBuilder[] functionBuilders =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[filterFunctionBuilders.size()];</span><br><span class="line"></span><br><span class="line">            <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">                    QueryBuilders.functionScoreQuery(functionBuilders)</span><br><span class="line">                                 .scoreMode(FunctionScoreQuery.ScoreMode.SUM) <span class="comment">// 对结果分数求和</span></span><br><span class="line">                                 .setMinScore(<span class="number">2</span>); <span class="comment">// 设置最小权重分为2</span></span><br><span class="line">            nativeSearchQueryBuilder.withQuery(functionScoreQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排序</span></span><br><span class="line">        <span class="keyword">if</span>(sort == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// 按新品从新到旧</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;id&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// 按销量从高到低</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;sale&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 按价格从低到高</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.ASC));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(sort == <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="comment">// 按价格从高到低</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 按相关度，即文档得分</span></span><br><span class="line">            nativeSearchQueryBuilder.withSorts(SortBuilders.scoreSort().order(SortOrder.DESC));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// NativeSearchQuery 查询对象</span></span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> nativeSearchQueryBuilder.build();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;DSL: &#123;&#125;&quot;</span>, searchQuery.getQuery().toString());</span><br><span class="line">        <span class="comment">// 查询结果Hit数组</span></span><br><span class="line">        SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">        <span class="comment">// 查询到的总条数</span></span><br><span class="line">        <span class="keyword">if</span>(searchHits.getTotalHits() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 没有查询到，返回空</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty(), pageRequest, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取查询到的对象</span></span><br><span class="line">        List&lt;EsProduct&gt; products = searchHits.stream()</span><br><span class="line">                                             .map(SearchHit::getContent)</span><br><span class="line">                                             .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装为分页对象返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(products, pageRequest, searchHits.getTotalHits());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;EsProduct&gt; <span class="title function_">recommend</span><span class="params">(Long id, Integer pageNum, Integer pageSize)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 封装分页信息对象</span></span><br><span class="line">        <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(pageNum, pageSize);</span><br><span class="line">        <span class="comment">// 从数据库中获取对应id商品</span></span><br><span class="line">        List&lt;EsProduct&gt; esProductList = productDao.getAllEsProductList(id);</span><br><span class="line">        <span class="comment">// 如果获取到该商品</span></span><br><span class="line">        <span class="keyword">if</span>(esProductList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 获取该商品对象</span></span><br><span class="line">            <span class="type">EsProduct</span> <span class="variable">esProduct</span> <span class="operator">=</span> esProductList.get(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 获取商品名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">keyword</span> <span class="operator">=</span> esProduct.getName();</span><br><span class="line">            <span class="comment">// 获取品牌id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> esProduct.getBrandId();</span><br><span class="line">            <span class="comment">// 获取商品属性类别id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">productCategoryId</span> <span class="operator">=</span> esProduct.getProductCategoryId();</span><br><span class="line">            <span class="comment">//根据商品标题、品牌、分类进行搜索</span></span><br><span class="line">            <span class="comment">// 多字段权重排序</span></span><br><span class="line">            List&lt;FunctionScoreQueryBuilder.FilterFunctionBuilder&gt; filterFunctionBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">8</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;subTitle&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;keywords&quot;</span>, keyword),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;brandId&quot;</span>, brandId),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">5</span>)));</span><br><span class="line">            filterFunctionBuilders.add(<span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;productCategoryId&quot;</span>, productCategoryId),</span><br><span class="line">                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">3</span>)));</span><br><span class="line">            FunctionScoreQueryBuilder.FilterFunctionBuilder[] builders =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[filterFunctionBuilders.size()];</span><br><span class="line">            filterFunctionBuilders.toArray(builders);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 允许自定评分的函数查询</span></span><br><span class="line">            <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">                    QueryBuilders.functionScoreQuery(builders)</span><br><span class="line">                                 .scoreMode(FunctionScoreQuery.ScoreMode.SUM)</span><br><span class="line">                                 .setMinScore(<span class="number">2</span>);</span><br><span class="line">            <span class="comment">//用于过滤掉相同的商品</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>()</span><br><span class="line">                    .mustNot(QueryBuilders.termQuery(<span class="string">&quot;id&quot;</span>, id));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//构建查询条件</span></span><br><span class="line">            <span class="type">NativeSearchQueryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>().withQuery(functionScoreQueryBuilder)</span><br><span class="line">                                                  .withFilter(boolQueryBuilder)</span><br><span class="line">                                                  .withPageable(pageable);</span><br><span class="line">            <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> builder.build();</span><br><span class="line">            LOGGER.info(<span class="string">&quot;DSL: &#123;&#125;&quot;</span>, searchQuery.getQuery().toString());</span><br><span class="line"></span><br><span class="line">            SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">            <span class="keyword">if</span>(searchHits.getTotalHits() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty(), pageable, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;EsProduct&gt; searchProductList =</span><br><span class="line">                    searchHits.stream()</span><br><span class="line">                              .map(SearchHit::getContent)</span><br><span class="line">                              .collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(searchProductList, pageable, searchHits.getTotalHits());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Page&lt;EsProduct&gt; <span class="title function_">recommendSub</span><span class="params">(Long id, Integer pageNum, Integer pageSize)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 封装分页信息对象</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(pageNum, pageSize);</span><br><span class="line">        <span class="comment">// 从数据库中获取对应id商品</span></span><br><span class="line">        List&lt;EsProduct&gt; esProducts = productDao.getAllEsProductList(id);</span><br><span class="line">        <span class="comment">// 如果获取到该商品</span></span><br><span class="line">        <span class="keyword">if</span>(esProducts.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 获取该商品对象</span></span><br><span class="line">            <span class="type">EsProduct</span> <span class="variable">esProduct</span> <span class="operator">=</span> esProducts.get(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 获取商品名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">keyword</span> <span class="operator">=</span> esProduct.getName();</span><br><span class="line">            <span class="comment">// 获取品牌id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> esProduct.getBrandId();</span><br><span class="line">            <span class="comment">// 获取商品属性类别id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">productCategoryId</span> <span class="operator">=</span> esProduct.getProductCategoryId();</span><br><span class="line">            <span class="comment">// 根据商品标题、品牌、分类进行搜索</span></span><br><span class="line">            <span class="comment">// 多字段权重排序</span></span><br><span class="line">            FunctionScoreQueryBuilder.FilterFunctionBuilder[] builders =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span>.FilterFunctionBuilder[]&#123;</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, keyword),</span><br><span class="line">                                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">8</span>)),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;subTitle&quot;</span>, keyword),</span><br><span class="line">                                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;keywords&quot;</span>, keyword),</span><br><span class="line">                                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">2</span>)),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;brandId&quot;</span>, brandId),</span><br><span class="line">                                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">5</span>)),</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">FunctionScoreQueryBuilder</span></span><br><span class="line">                                    .FilterFunctionBuilder(QueryBuilders.matchQuery(<span class="string">&quot;productCategoryId&quot;</span>, productCategoryId),</span><br><span class="line">                                                           ScoreFunctionBuilders.weightFactorFunction(<span class="number">3</span>))</span><br><span class="line">                    &#125;;</span><br><span class="line">            <span class="comment">// 构建QueryBuilder</span></span><br><span class="line">            <span class="type">FunctionScoreQueryBuilder</span> <span class="variable">functionScoreQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">                    QueryBuilders.functionScoreQuery(builders) <span class="comment">// 允许自定评分的函数查询</span></span><br><span class="line">                                 .scoreMode(FunctionScoreQuery.ScoreMode.SUM)</span><br><span class="line">                                 .setMinScore(<span class="number">2</span>);</span><br><span class="line">            <span class="comment">//用于过滤掉相同的商品</span></span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>()</span><br><span class="line">                    .mustNot(QueryBuilders.termQuery(<span class="string">&quot;id&quot;</span>, id));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建nativeSearchQuery</span></span><br><span class="line">            <span class="type">NativeSearchQuery</span> <span class="variable">nativeSearchQuery</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>().withQuery(functionScoreQueryBuilder)</span><br><span class="line">                                                  .withFilter(boolQueryBuilder)</span><br><span class="line">                                                  .withPageable(pageRequest)</span><br><span class="line">                                                  .build();</span><br><span class="line">            LOGGER.info(<span class="string">&quot;DSL: &#123;&#125;&quot;</span>, nativeSearchQuery.getQuery().toString());</span><br><span class="line">            SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(nativeSearchQuery, EsProduct.class);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;最大得分：&#123;&#125;&quot;</span>, searchHits.getMaxScore());</span><br><span class="line">            LOGGER.info(<span class="string">&quot;文档总条数：&#123;&#125;&quot;</span>, searchHits.getTotalHits());</span><br><span class="line">            <span class="keyword">if</span>(searchHits.getTotalHits() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty(), pageRequest, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;EsProduct&gt; esProductList = searchHits.stream()</span><br><span class="line">                                                      .map(SearchHit::getContent)</span><br><span class="line">                                                      .collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(esProductList, pageRequest, searchHits.getTotalHits());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(ListUtil.empty());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EsProductRelatedInfo <span class="title function_">searchRelatedInfo</span><span class="params">(String keyword)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">NativeSearchQueryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//搜索条件</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">            builder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            builder.withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;subTitle&quot;</span>, <span class="string">&quot;keywords&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//聚合搜索品牌名称</span></span><br><span class="line">        builder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;brandNames&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>));</span><br><span class="line">        <span class="comment">//集合搜索分类名称</span></span><br><span class="line">        builder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;productCategoryNames&quot;</span>).field(<span class="string">&quot;productCategoryName&quot;</span>));</span><br><span class="line">        <span class="comment">//聚合搜索商品属性，去除type=1的属性</span></span><br><span class="line">        <span class="type">NestedAggregationBuilder</span> <span class="variable">aggregationBuilder</span> <span class="operator">=</span></span><br><span class="line">                AggregationBuilders.nested(<span class="string">&quot;allAttrValues&quot;</span>,</span><br><span class="line">                                           <span class="string">&quot;attrValueList&quot;</span>)</span><br><span class="line">                                   .subAggregation(AggregationBuilders</span><br><span class="line">                                                           .filter(<span class="string">&quot;productAttrs&quot;</span>,</span><br><span class="line">                                                                   QueryBuilders.termQuery(<span class="string">&quot;attrValueList.type&quot;</span>,<span class="number">1</span>))</span><br><span class="line">                                                           .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrIds&quot;</span>)</span><br><span class="line">                                                                                              .field(<span class="string">&quot;attrValueList.productAttributeId&quot;</span>)</span><br><span class="line">                                                                                              .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrValues&quot;</span>)</span><br><span class="line">                                                                                                                                 .field(<span class="string">&quot;attrValueList.value&quot;</span>))</span><br><span class="line">                                                                                              .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrNames&quot;</span>)</span><br><span class="line">                                                                                                                                 .field(<span class="string">&quot;attrValueList.name&quot;</span>))));</span><br><span class="line">        builder.withAggregations(aggregationBuilder);</span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">        <span class="keyword">return</span> convertProductRelatedInfo(searchHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里也不对</span></span><br><span class="line">    <span class="keyword">public</span> EsProductRelatedInfo <span class="title function_">searchRelatedInfoSub</span><span class="params">(String keyword)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取NativeSearchQueryBuilder</span></span><br><span class="line">        <span class="type">NativeSearchQueryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//搜索条件</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">            <span class="comment">// 如果关键词为空，就查询所有</span></span><br><span class="line">            builder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 进行多字段查询</span></span><br><span class="line">            builder.withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;subTitle&quot;</span>, <span class="string">&quot;keywords&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">                <span class="comment">//聚合搜索品牌名称</span></span><br><span class="line">        builder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;brandNames&quot;</span>) <span class="comment">// 给分组命名</span></span><br><span class="line">                                                    .field(<span class="string">&quot;brandName&quot;</span>)) <span class="comment">// 对哪个字段进行聚合函数</span></span><br><span class="line">               <span class="comment">//聚合搜索分类名称</span></span><br><span class="line">               .withAggregations(AggregationBuilders.terms(<span class="string">&quot;productCategoryNames&quot;</span>) <span class="comment">// 给分组命名</span></span><br><span class="line">                                                    .field(<span class="string">&quot;productCategoryName&quot;</span>));</span><br><span class="line">        <span class="comment">//聚合搜索商品属性，去除type=1的属性</span></span><br><span class="line">        <span class="type">NestedAggregationBuilder</span> <span class="variable">aggregationBuilder</span> <span class="operator">=</span></span><br><span class="line">                AggregationBuilders.nested(<span class="string">&quot;allAttrValues&quot;</span>,</span><br><span class="line">                                           <span class="string">&quot;attrValueList&quot;</span>) <span class="comment">// 对attrValueList进行聚合查询</span></span><br><span class="line">                                   <span class="comment">// 子聚合</span></span><br><span class="line">                                   .subAggregations(<span class="keyword">new</span> <span class="title class_">AggregatorFactories</span>.Builder()</span><br><span class="line">                                                            <span class="comment">// 添加过滤器，取出type=1的attrValue</span></span><br><span class="line">                                                            .addAggregator(AggregationBuilders.filter(<span class="string">&quot;productAttrs&quot;</span>,</span><br><span class="line">                                                                                           QueryBuilders.termQuery(<span class="string">&quot;attrValueList.type&quot;</span>,<span class="number">1</span>)))</span><br><span class="line">                                                            .addAggregator(AggregationBuilders.terms(<span class="string">&quot;attrIds&quot;</span>) <span class="comment">// 使用该名称创建新的聚合</span></span><br><span class="line">                                                                                              .field(<span class="string">&quot;attrValueList.productAttributeId&quot;</span>))</span><br><span class="line">                                                            .addAggregator(AggregationBuilders.terms(<span class="string">&quot;attrValues&quot;</span>)</span><br><span class="line">                                                                                              .field(<span class="string">&quot;attrValueList.value&quot;</span>))</span><br><span class="line">                                                            .addAggregator(AggregationBuilders.terms(<span class="string">&quot;attrNames&quot;</span>)</span><br><span class="line">                                                                                              .field(<span class="string">&quot;attrValueList.name&quot;</span>)));</span><br><span class="line">        <span class="comment">// 针对前面子聚合，实际上是按这样一种方式聚合</span></span><br><span class="line">        <span class="comment">// &quot;aggregations&quot;: &#123; &quot;attrIds&quot;: &#123; &quot;aggregations&quot;: &#123; &quot;attrValues&quot;: &#123;&#125;, &quot;attrNames&quot;: &#123;&#125; &#125; &#125; &#125;</span></span><br><span class="line">        builder.withAggregations(aggregationBuilder);</span><br><span class="line">        <span class="comment">// 构建NativeSearchQuery对象</span></span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">        <span class="keyword">return</span> convertProductRelatedInfo(searchHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写得不对，当个错误示范</span></span><br><span class="line">    <span class="keyword">public</span> EsProductRelatedInfo <span class="title function_">searchRelatedInfoSub1</span><span class="params">(String keyword)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取NativeSearchQueryBuilder</span></span><br><span class="line">        <span class="type">NativeSearchQueryBuilder</span> <span class="variable">nativeSearchQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//搜索条件</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">            <span class="comment">// 如果关键词为空，就查询所有</span></span><br><span class="line">            nativeSearchQueryBuilder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 进行多字段查询</span></span><br><span class="line">            nativeSearchQueryBuilder.withQuery(QueryBuilders.multiMatchQuery(keyword,</span><br><span class="line">                                                                             <span class="string">&quot;name&quot;</span>, <span class="string">&quot;subTitle&quot;</span>, <span class="string">&quot;keywords&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">                                 <span class="comment">//聚合搜索品牌名称</span></span><br><span class="line">        nativeSearchQueryBuilder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;brandNames&quot;</span>)</span><br><span class="line">                                                 .field(<span class="string">&quot;brandName&quot;</span>))</span><br><span class="line">                                <span class="comment">//聚合搜索分类名称</span></span><br><span class="line">                                .withAggregations(AggregationBuilders.terms(<span class="string">&quot;productCategoryNames&quot;</span>)</span><br><span class="line">                                                                     .field(<span class="string">&quot;productCategoryName&quot;</span>));</span><br><span class="line">        <span class="comment">//聚合搜索商品属性，去除type=1的属性</span></span><br><span class="line">        <span class="type">NestedAggregationBuilder</span> <span class="variable">nestedAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.nested(<span class="string">&quot;allAttrValues&quot;</span>, <span class="string">&quot;attrValueList&quot;</span>)</span><br><span class="line">                                                                               .subAggregations(</span><br><span class="line">            																		   <span class="comment">// 这里返回的是空</span></span><br><span class="line">                                                                                       <span class="keyword">new</span> <span class="title class_">AggregatorFactories</span>.Builder()</span><br><span class="line">                                                                                               .addAggregator(</span><br><span class="line">                                                                                                       AggregationBuilders</span><br><span class="line">                                                                                                               .filter(<span class="string">&quot;productAttrs&quot;</span>,</span><br><span class="line">                                                                                                                       QueryBuilders</span><br><span class="line">                                                                                                                               .termQuery(<span class="string">&quot;attrValueList.type&quot;</span>, <span class="number">1</span>)))</span><br><span class="line">                                                                                               .addAggregator(</span><br><span class="line">                                                                                                       AggregationBuilders</span><br><span class="line">                                                                                                               .terms(<span class="string">&quot;attrIds&quot;</span>) <span class="comment">// 使用该名称创建新的聚合</span></span><br><span class="line">                                                                                                               .field(<span class="string">&quot;attrValueList.productAttributeId&quot;</span>))</span><br><span class="line">                                                                                               .addAggregator(</span><br><span class="line">                                                                                                       AggregationBuilders</span><br><span class="line">                                                                                                               .terms(<span class="string">&quot;attrValues&quot;</span>)</span><br><span class="line">                                                                                                               .field(<span class="string">&quot;attrValueList.value&quot;</span>))</span><br><span class="line">                                                                                               .addAggregator(</span><br><span class="line">                                                                                                       AggregationBuilders</span><br><span class="line">                                                                                                               .terms(<span class="string">&quot;attrNames&quot;</span>)</span><br><span class="line">                                                                                                               .field(<span class="string">&quot;attrValueList.name&quot;</span>)));</span><br><span class="line">        nativeSearchQueryBuilder.withAggregations(nestedAggregationBuilder);</span><br><span class="line">        <span class="comment">// 构建NativeSearchQuery对象</span></span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">nativeSearchQuery</span> <span class="operator">=</span> nativeSearchQueryBuilder.build();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;DSL: &#123;&#125;&quot;</span>,nativeSearchQuery.getQuery().toString());</span><br><span class="line">        SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(nativeSearchQuery, EsProduct.class);</span><br><span class="line">        <span class="keyword">return</span> convertProductRelatedInfo(searchHits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将返回结果转换为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> EsProductRelatedInfo <span class="title function_">convertProductRelatedInfo</span><span class="params">(SearchHits&lt;EsProduct&gt; response)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建EsProductRelatedInfo对象</span></span><br><span class="line">        <span class="type">EsProductRelatedInfo</span> <span class="variable">productRelatedInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsProductRelatedInfo</span>();</span><br><span class="line">        <span class="comment">// 将hits中的aggregations转换为map对象</span></span><br><span class="line">        Map&lt;String, Aggregation&gt; aggregationMap =</span><br><span class="line">                ((Aggregations) response.getAggregations()</span><br><span class="line">                                        .aggregations()).asMap();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;aggregationMap：&#123;&#125;&quot;</span>, aggregationMap.toString());</span><br><span class="line">        <span class="comment">//设置品牌</span></span><br><span class="line">        <span class="type">Aggregation</span> <span class="variable">brandNames</span> <span class="operator">=</span> aggregationMap.get(<span class="string">&quot;brandNames&quot;</span>);</span><br><span class="line">        List&lt;String&gt; brandNameList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ((Terms) brandNames).getBuckets().size(); i++)&#123;</span><br><span class="line">            brandNameList.add(((Terms) brandNames)</span><br><span class="line">                                      .getBuckets()</span><br><span class="line">                                      .get(i)</span><br><span class="line">                                      .getKeyAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        productRelatedInfo.setBrandNames(brandNameList);</span><br><span class="line">        <span class="comment">//设置分类</span></span><br><span class="line">        <span class="type">Aggregation</span> <span class="variable">productCategoryNames</span> <span class="operator">=</span> aggregationMap.get(<span class="string">&quot;productCategoryNames&quot;</span>);</span><br><span class="line">        List&lt;String&gt; productCategoryNameList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ((Terms) productCategoryNames).getBuckets().size(); i++)&#123;</span><br><span class="line">            productCategoryNameList.add(((Terms) productCategoryNames)</span><br><span class="line">                                                .getBuckets()</span><br><span class="line">                                                .get(i)</span><br><span class="line">                                                .getKeyAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        productRelatedInfo.setProductCategoryNames(productCategoryNameList);</span><br><span class="line">        <span class="comment">//设置参数</span></span><br><span class="line">        <span class="type">Aggregation</span> <span class="variable">productAttrs</span> <span class="operator">=</span> aggregationMap.get(<span class="string">&quot;allAttrValues&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; attrIds =</span><br><span class="line">                ((ParsedLongTerms) ((ParsedFilter) ((ParsedNested) productAttrs)</span><br><span class="line">                        .getAggregations()</span><br><span class="line">                        .get(<span class="string">&quot;productAttrs&quot;</span>))</span><br><span class="line">                        .getAggregations()</span><br><span class="line">                        .get(<span class="string">&quot;attrIds&quot;</span>))</span><br><span class="line">                        .getBuckets();</span><br><span class="line">        List&lt;EsProductRelatedInfo.ProductAttr&gt; attrList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Terms.Bucket attrId : attrIds)&#123;</span><br><span class="line">            EsProductRelatedInfo.<span class="type">ProductAttr</span> <span class="variable">attr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsProductRelatedInfo</span>.ProductAttr();</span><br><span class="line">            attr.setAttrId((Long) attrId.getKey());</span><br><span class="line">            List&lt;String&gt; attrValueList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; attrValues =</span><br><span class="line">                    ((ParsedStringTerms) attrId.getAggregations()</span><br><span class="line">                                               .get(<span class="string">&quot;attrValues&quot;</span>))</span><br><span class="line">                            .getBuckets();</span><br><span class="line">            List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; attrNames =</span><br><span class="line">                    ((ParsedStringTerms) attrId.getAggregations()</span><br><span class="line">                                               .get(<span class="string">&quot;attrNames&quot;</span>))</span><br><span class="line">                            .getBuckets();</span><br><span class="line">            <span class="keyword">for</span>(Terms.Bucket attrValue : attrValues)&#123;</span><br><span class="line">                attrValueList.add(attrValue.getKeyAsString());</span><br><span class="line">            &#125;</span><br><span class="line">            attr.setAttrValues(attrValueList);</span><br><span class="line">            <span class="keyword">if</span>(!CollectionUtils.isEmpty(attrNames))&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> attrNames.get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">                attr.setAttrName(attrName);</span><br><span class="line">            &#125;</span><br><span class="line">            attrList.add(attr);</span><br><span class="line">        &#125;</span><br><span class="line">        productRelatedInfo.setProductAttrs(attrList);</span><br><span class="line">        <span class="keyword">return</span> productRelatedInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将返回结果转换为对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> EsProductRelatedInfo <span class="title function_">convertProductRelatedInfoSub</span><span class="params">(SearchHits&lt;EsProduct&gt; response)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建EsProductRelatedInfo对象</span></span><br><span class="line">        <span class="type">EsProductRelatedInfo</span> <span class="variable">productRelatedInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsProductRelatedInfo</span>();</span><br><span class="line">        <span class="comment">// 将hits中的aggregations转换为map对象</span></span><br><span class="line">        Map&lt;String, Aggregation&gt; aggregationMap = ((Aggregations) Objects</span><br><span class="line">                .requireNonNull(response.getAggregations())</span><br><span class="line">                .aggregations())</span><br><span class="line">                .asMap();</span><br><span class="line">        <span class="comment">//设置品牌</span></span><br><span class="line">        <span class="type">Terms</span> <span class="variable">brandNames</span> <span class="operator">=</span> (Terms) aggregationMap.get(<span class="string">&quot;brandNames&quot;</span>);</span><br><span class="line">        List&lt;String&gt; brandNameList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        brandNames.getBuckets()</span><br><span class="line">                  .forEach(brandName -&gt; brandNameList.add(brandName.getKeyAsString()));</span><br><span class="line">        productRelatedInfo.setBrandNames(brandNameList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置分类</span></span><br><span class="line">        <span class="type">Terms</span> <span class="variable">productCategoryNames</span> <span class="operator">=</span> (Terms) aggregationMap.get(<span class="string">&quot;productCategoryNames&quot;</span>);</span><br><span class="line">        List&lt;String&gt; productCategoryNameList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        productCategoryNames.getBuckets()</span><br><span class="line">                            .forEach(productCategoryName -&gt;</span><br><span class="line">                                             productCategoryNameList</span><br><span class="line">                                                     .add(productCategoryName.getKeyAsString()));</span><br><span class="line">        productRelatedInfo.setProductCategoryNames(productCategoryNameList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取nested</span></span><br><span class="line">        <span class="type">ParsedNested</span> <span class="variable">allAttrValues</span> <span class="operator">=</span> (ParsedNested) aggregationMap.get(<span class="string">&quot;allAttrValues&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取filter</span></span><br><span class="line">        <span class="type">ParsedFilter</span> <span class="variable">productAttrs</span> <span class="operator">=</span> allAttrValues.getAggregations().get(<span class="string">&quot;productAttrs&quot;</span>);</span><br><span class="line">        <span class="comment">// 按照字段类型获取获取terms，attrId为Long类型</span></span><br><span class="line">        <span class="type">ParsedLongTerms</span> <span class="variable">attrIds</span> <span class="operator">=</span> productAttrs.getAggregations().get(<span class="string">&quot;attrIds&quot;</span>);</span><br><span class="line">        <span class="comment">// 处理子聚合返回结果，构建为内部类对象</span></span><br><span class="line">        <span class="comment">// 针对前面子聚合，实际上是按这样一种方式聚合</span></span><br><span class="line">        <span class="comment">// &quot;aggregations&quot;: &#123; &quot;attrIds&quot;: &#123; &quot;aggregations&quot;: &#123; &quot;attrValues&quot;: &#123;&#125;, &quot;attrNames&quot;: &#123;&#125; &#125; &#125; &#125;</span></span><br><span class="line">        List&lt;EsProductRelatedInfo.ProductAttr&gt; productAttrList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        attrIds.getBuckets().forEach(attrId -&gt; &#123;</span><br><span class="line">            EsProductRelatedInfo.<span class="type">ProductAttr</span> <span class="variable">productAttr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsProductRelatedInfo</span>.ProductAttr();</span><br><span class="line">            productAttr.setAttrId(Long.valueOf(attrId.getKey().toString()));</span><br><span class="line">            <span class="type">ParsedStringTerms</span> <span class="variable">attrNames</span> <span class="operator">=</span> attrId.getAggregations().get(<span class="string">&quot;attrNames&quot;</span>);</span><br><span class="line">            productAttr.setAttrName(Objects.requireNonNull(attrNames.getBuckets())</span><br><span class="line">                                           .get(<span class="number">0</span>)</span><br><span class="line">                                           .getKeyAsString());</span><br><span class="line">            <span class="type">ParsedStringTerms</span> <span class="variable">attrValues</span> <span class="operator">=</span> attrId.getAggregations().get(<span class="string">&quot;attrValues&quot;</span>);</span><br><span class="line">            List&lt;String&gt; attrValueList =</span><br><span class="line">                    attrValues.getBuckets()</span><br><span class="line">                              .stream()</span><br><span class="line">                              .map((MultiBucketsAggregation.Bucket::getKeyAsString))</span><br><span class="line">                              .collect(Collectors.toList());</span><br><span class="line">            productAttr.setAttrValues(attrValueList);</span><br><span class="line">            productAttrList.add(productAttr);</span><br><span class="line">        &#125;);</span><br><span class="line">        productRelatedInfo.setProductAttrs(productAttrList);</span><br><span class="line">        <span class="keyword">return</span> productRelatedInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加EsProductController定义接口"><a href="#添加EsProductController定义接口" class="headerlink" title="添加EsProductController定义接口"></a>添加EsProductController定义接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索商品管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;EsProductController&quot;)</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;EsProductController&quot;,description = &quot;搜索商品管理&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/esProduct&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsProductController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EsProductService esProductService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;导入所有数据库中商品到ES&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/importAll&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Integer&gt; <span class="title function_">importAllList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 返回导入的数据条数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> esProductService.importAll();</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据id删除商品&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/delete/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Object&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        esProductService.delete(id);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据id批量删除商品&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/delete/batch&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Object&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        esProductService.delete(ids);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据id创建商品&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/create/&#123;id&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;EsProduct&gt; <span class="title function_">create</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">EsProduct</span> <span class="variable">esProduct</span> <span class="operator">=</span> esProductService.create(id);</span><br><span class="line">        <span class="keyword">if</span> (esProduct != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> CommonResult.success(esProduct);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> CommonResult.failed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestParam(required = false)，没有携带参数时将参数设置为空</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;简单搜索&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/search/simple&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;CommonPage&lt;EsProduct&gt;&gt; <span class="title function_">search</span><span class="params">(<span class="meta">@RequestParam(required = false)</span> String keyword,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> Integer pageNum,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false, defaultValue = &quot;5&quot;)</span> Integer pageSize)</span> &#123;</span><br><span class="line">        Page&lt;EsProduct&gt; esProductPage = esProductService.search(keyword, pageNum, pageSize);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(CommonPage.restPage(esProductPage));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;综合搜索、筛选、排序&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam(name = &quot;sort&quot;, value = &quot;排序字段:0-&gt;按相关度；1-&gt;按新品；2-&gt;按销量；3-&gt;价格从低到高；4-&gt;价格从高到低&quot;,</span></span><br><span class="line"><span class="meta">            defaultValue = &quot;0&quot;, allowableValues = &quot;0,1,2,3,4&quot;, paramType = &quot;query&quot;, dataType = &quot;integer&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/search&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;CommonPage&lt;EsProduct&gt;&gt; <span class="title function_">search</span><span class="params">(<span class="meta">@RequestParam(required = false)</span> String keyword,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false)</span> Long brandId,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false)</span> Long productCategoryId,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> Integer pageNum,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false, defaultValue = &quot;5&quot;)</span> Integer pageSize,</span></span><br><span class="line"><span class="params">                                                      <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> Integer sort)</span> &#123;</span><br><span class="line">        Page&lt;EsProduct&gt; esProductPage = esProductService.search(keyword, brandId, productCategoryId, pageNum, pageSize, sort);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(CommonPage.restPage(esProductPage));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据商品id推荐商品&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/recommend/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;CommonPage&lt;EsProduct&gt;&gt; <span class="title function_">recommend</span><span class="params">(<span class="meta">@PathVariable</span> Long id,</span></span><br><span class="line"><span class="params">                                                         <span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> Integer pageNum,</span></span><br><span class="line"><span class="params">                                                         <span class="meta">@RequestParam(required = false, defaultValue = &quot;5&quot;)</span> Integer pageSize)</span> &#123;</span><br><span class="line">        Page&lt;EsProduct&gt; esProductPage = esProductService.recommend(id, pageNum, pageSize);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(CommonPage.restPage(esProductPage));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;获取搜索的相关品牌、分类及筛选属性&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/search/relate&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;EsProductRelatedInfo&gt; <span class="title function_">searchRelatedInfo</span><span class="params">(<span class="meta">@RequestParam(required = false)</span> String keyword)</span> &#123;</span><br><span class="line">        <span class="type">EsProductRelatedInfo</span> <span class="variable">productRelatedInfo</span> <span class="operator">=</span> esProductService.searchRelatedInfo(keyword);</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(productRelatedInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="聚合搜索商品相关信息"><a href="#聚合搜索商品相关信息" class="headerlink" title="聚合搜索商品相关信息"></a>聚合搜索商品相关信息</h3><blockquote>
<p><strong>在搜索商品时，经常会有一个筛选界面来帮助我们找到想要的商品，这里使用Elasticsearch来简单实现下</strong></p>
</blockquote>
<ul>
<li><strong>首先来说下需求，可以根据搜索关键字获取到与关键字匹配商品相关的分类、品牌及属性，下面这张图有助于理解</strong></li>
</ul>
<p><img src="/image/elasticsearch/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="聚合搜索示例图"></p>
<ul>
<li><p><strong>这里我们可以使用Elasticsearch的聚合来实现，搜索出相关商品，聚合出商品的品牌、商品的分类以及商品的属性，只要出现次数最多的前十个即可</strong></p>
</li>
<li><p><strong>使用Query DSL调用Elasticsearch的Restful API实现</strong></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">POST /pms/product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;小米&quot;,</span><br><span class="line">      &quot;fields&quot;: [</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;subTitle&quot;,</span><br><span class="line">        &quot;keywords&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brandNames&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brandName&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;productCategoryNames&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;productCategoryName&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;allAttrValues&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;attrValueList&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;productAttrs&quot;: &#123;</span><br><span class="line">          &quot;filter&quot;: &#123;</span><br><span class="line">            &quot;term&quot;: &#123;</span><br><span class="line">              &quot;attrValueList.type&quot;: 1</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;attrIds&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;attrValueList.productAttributeId&quot;,</span><br><span class="line">                &quot;size&quot;: 10</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;attrValues&quot;: &#123;</span><br><span class="line">                  &quot;terms&quot;: &#123;</span><br><span class="line">                    &quot;field&quot;: &quot;attrValueList.value&quot;,</span><br><span class="line">                    &quot;size&quot;: 10</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;attrNames&quot;: &#123;</span><br><span class="line">                  &quot;terms&quot;: &#123;</span><br><span class="line">                    &quot;field&quot;: &quot;attrValueList.name&quot;,</span><br><span class="line">                    &quot;size&quot;: 10</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>在SpringBoot中实现聚合操作比较复杂，已经超出了ElasticsearchRepository的使用范围，需要直接使用ElasticsearchRestTemplate来实现</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> EsProductRelatedInfo <span class="title function_">searchRelatedInfo</span><span class="params">(String keyword)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">NativeSearchQueryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line">    <span class="comment">//搜索条件</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isEmpty(keyword))&#123;</span><br><span class="line">        <span class="comment">// 如果关键词为空，就查询所有</span></span><br><span class="line">        builder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 进行多字段查询</span></span><br><span class="line">        builder.withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;subTitle&quot;</span>, <span class="string">&quot;keywords&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//聚合搜索品牌名称</span></span><br><span class="line">    builder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;brandNames&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>));</span><br><span class="line">    <span class="comment">//集合搜索分类名称</span></span><br><span class="line">    builder.withAggregations(AggregationBuilders.terms(<span class="string">&quot;productCategoryNames&quot;</span>).field(<span class="string">&quot;productCategoryName&quot;</span>));</span><br><span class="line">    <span class="comment">//聚合搜索商品属性，去除type=1的属性</span></span><br><span class="line">    <span class="type">NestedAggregationBuilder</span> <span class="variable">aggregationBuilder</span> <span class="operator">=</span></span><br><span class="line">        AggregationBuilders.nested(<span class="string">&quot;allAttrValues&quot;</span>, <span class="string">&quot;attrValueList&quot;</span>)</span><br><span class="line">        .subAggregation(AggregationBuilders.filter(<span class="string">&quot;productAttrs&quot;</span>, QueryBuilders.termQuery(<span class="string">&quot;attrValueList.type&quot;</span>,<span class="number">1</span>))</span><br><span class="line">                        .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrIds&quot;</span>).field(<span class="string">&quot;attrValueList.productAttributeId&quot;</span>)</span><br><span class="line">                                        .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrValues&quot;</span>).field(<span class="string">&quot;attrValueList.value&quot;</span>))</span><br><span class="line">                                        .subAggregation(AggregationBuilders.terms(<span class="string">&quot;attrNames&quot;</span>).field(<span class="string">&quot;attrValueList.name&quot;</span>))));</span><br><span class="line">    builder.withAggregations(aggregationBuilder);</span><br><span class="line">    <span class="type">NativeSearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> builder.build();</span><br><span class="line">    SearchHits&lt;EsProduct&gt; searchHits = elasticsearchRestTemplate.search(searchQuery, EsProduct.class);</span><br><span class="line">    <span class="keyword">return</span> convertProductRelatedInfo(searchHits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><blockquote>
<p><strong>关于Spring Data Elasticsearch的具体使用可以参考官方文档</strong></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#reference">https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#reference</a></p>

  </div>
</article>




          
          <!-- //actions_mobile 移动端导航栏 -->
            <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" class="Popup" style="display: none">
      <ul>
         
          <li><a href="/blog/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer"  class="Popup" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mall%E6%95%B4%E5%90%88Elasticsearch%E5%AE%9E%E7%8E%B0%E5%95%86%E5%93%81%E6%90%9C%E7%B4%A2"><span class="toc-number">1.</span> <span class="toc-text">mall整合Elasticsearch实现商品搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">项目使用框架介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.1.1.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Data-Elasticsearch"><span class="toc-number">1.1.2.</span> <span class="toc-text">Spring Data Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">常用注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Document"><span class="toc-number">1.1.2.1.1.</span> <span class="toc-text">@Document</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Id"><span class="toc-number">1.1.2.1.2.</span> <span class="toc-text">@Id</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Field"><span class="toc-number">1.1.2.1.3.</span> <span class="toc-text">@Field</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Data%E6%96%B9%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">Spring Data方式的数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%8D%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">衍生查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Query%E6%B3%A8%E8%A7%A3%E5%8F%AF%E4%BB%A5%E7%94%A8Elasticsearch%E7%9A%84DSL%E8%AF%AD%E5%8F%A5%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">使用@Query注解可以用Elasticsearch的DSL语句进行查询</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E8%A1%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.</span> <span class="toc-text">项目使用表说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%90%88Elasticsearch%E5%AE%9E%E7%8E%B0%E5%95%86%E5%93%81%E6%90%9C%E7%B4%A2"><span class="toc-number">1.3.</span> <span class="toc-text">整合Elasticsearch实现商品搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8pom-xml%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">在pom.xml中添加相关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9SpringBoot%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">修改SpringBoot配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%95%86%E5%93%81%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1EsProduct"><span class="toc-number">1.3.3.</span> <span class="toc-text">添加商品文档对象EsProduct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0EsProductRepository%E6%8E%A5%E5%8F%A3%E7%94%A8%E4%BA%8E%E6%93%8D%E4%BD%9CElasticsearch"><span class="toc-number">1.3.4.</span> <span class="toc-text">添加EsProductRepository接口用于操作Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0EsProductService%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.5.</span> <span class="toc-text">添加EsProductService接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0EsProductService%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BBEsProductServiceImpl"><span class="toc-number">1.3.6.</span> <span class="toc-text">添加EsProductService接口的实现类EsProductServiceImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0EsProductController%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.7.</span> <span class="toc-text">添加EsProductController定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%95%86%E5%93%81%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.8.</span> <span class="toc-text">聚合搜索商品相关信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.3.9.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer"  class="Popup" style="display: none">
      <ul>
  <li> 开发中. </li>
  <!-- <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&text=mall整合Elasticsearch实现商品搜索"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&is_video=false&description=mall整合Elasticsearch实现商品搜索"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=mall整合Elasticsearch实现商品搜索&body=Check out this article: https://www.t1kcode.top/posts/20230323121710-57e98fa8.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&title=mall整合Elasticsearch实现商品搜索"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&name=mall整合Elasticsearch实现商品搜索&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.t1kcode.top/posts/20230323121710-57e98fa8.html&t=mall整合Elasticsearch实现商品搜索"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li> -->

</ul>

    </div>

    <div id="actions-footer">
        <span id="menu" Popup="#nav-footer" class="icon"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</span>
        <span id="toc" Popup="#toc-footer" class="icon"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</span>
        <span id="share" Popup="#share-footer" class="icon"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</span>
        <span id="top" Popup="" style="display:none" class="icon" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</span>
    </div>

  </div>
</div>

            <!-- 图片弹窗 -->
            <div class="img-pup" style="display: none;">
              <img>
            </div>
          

          <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2023
    t1k
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/blog/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

          <!-- jquery -->
 
  
<script src="/lib/jquery/jquery.min.js"></script>



<script src="/lib/jquery/jquery.pjax.js"></script>



<!-- clipboard -->

   
    
<script src="/lib/clipboard/clipboard.min.js"></script>

  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
      setTimeout(()=>{
        e.trigger.setAttribute('aria-label', "复制到粘贴板!");
      },1500)
    })
  })
  </script>



<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

     
      </div>   
    </div>
      
    
<script src="/js/main.js"></script>

    </body>
    </html>